<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ITIL v9.0 - Simulador Profesional Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root { --p: #4361ee; --s: #10b981; --w: #f59e0b; --d: #ef4444; --i: #3b82f6; --dark: #0f172a; }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a, #1e293b); color: #e2e8f0; min-height: 100vh; }
        header { background: rgba(15,23,42,0.98); backdrop-filter: blur(15px); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #334155; }
        .logo h1 { font-size: 3.2em; font-weight: 900; background: linear-gradient(90deg, #60a5fa, #a78bfa, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #clock { background: rgba(255,255,255,0.1); padding: 14px 30px; border-radius: 50px; font-weight: bold; }

        .dashboard { display: grid; grid-template-columns: 370px 1fr; height: calc(100vh - 100px); }
        .sidebar { background: rgba(15,23,42,0.98); padding: 30px; border-right: 1px solid #334155; overflow-y: auto; }
        .nav-btn { width: 100%; background: rgba(51,65,85,0.7); color: white; border: none; padding: 18px 22px; margin: 12px 0; border-radius: 16px; cursor: pointer; text-align: left; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 16px; transition: all 0.4s; }
        .nav-btn:hover, .nav-btn.active { background: linear-gradient(135deg, #4361ee, #3b82f6); transform: translateX(12px); box-shadow: 0 12px 35px rgba(67,97,238,0.6); }

        .main-content { padding: 40px; overflow-y: auto; }
        .widget { background: rgba(30,41,59,0.95); border-radius: 22px; padding: 35px; margin-bottom: 35px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 1px solid rgba(100,116,139,0.2); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(minmax(250px,1fr))); gap: 30px; margin: 40px 0; }
        .kpi-card { background: linear-gradient(135deg, rgba(51,65,85,0.9), rgba(30,41,59,1)); padding: 30px; border-radius: 20px; text-align: center; border-left: 8px solid #4361ee; transition: 0.4s; }
        .kpi-card:hover { transform: translateY(-12px); }
        .kpi-value { font-size: 4.5em; font-weight: 900; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin-top: 40px; }
        .chart-box { background: rgba(15,23,42,0.9); padding: 30px; border-radius: 20px; }

        .btn-giant { padding: 25px 50px; font-size: 1.7em; border: none; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; margin: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); transition: all 0.5s; }
        .btn-inc { background: linear-gradient(135deg, #dc2626, #f87171); }
        .btn-prob { background: linear-gradient(135deg, #ea580c, #fb923c); }
        .btn-resolve { background: linear-gradient(135deg, #10b981, #34d399); }
        .btn-stop { background: #6b7280; }
        .btn-giant:hover { transform: translateY(-15px) scale(1.05); }

        table { width: 100%; border-collapse: collapse; margin: 25px 0; }
        th, td { padding: 18px; border-bottom: 1px solid #475569; text-align: left; }
        th { background: rgba(67,97,238,0.5); }
        .status { padding: 8px 16px; border-radius: 30px; font-weight: bold; font-size: 0.9em; }
        .critica { background: #ef4444; } .alta { background:#f59e0b; color:black; } .media { background:#3b82f6; }
        .nuevo { background:#ef4444; } .en-investigacion { background:#f59e0b; color:black; } .resuelto { background:#10b981; }

        .simulation-box { background: rgba(15,23,42,0.95); border: 3px solid #10b981; border-radius: 20px; padding: 30px; margin-top: 40px; display: none; }
        .step { padding: 20px; background: rgba(51,65,85,0.7); border-radius: 14px; margin: 15px 0; border-left: 6px solid #64748b; opacity: 0; transform: translateX(-50px); transition: all 0.8s; }
        .step.show { opacity: 1; transform: translateX(0); }
        .step.success { border-left-color: #10b981; background: rgba(16,185,129,0.3); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; pointer-events: none; transition: 0.4s; }
        .modal.show { opacity: 1; pointer-events: all; }
        .modal-content { background: #1e293b; padding: 50px; border-radius: 24px; text-align: center; max-width: 600px; box-shadow: 0 30px 80px rgba(0,0,0,0.8); border: 2px solid #4361ee; }

        .toast { position: fixed; bottom: 30px; right: 30px; background: #10b981; color: white; padding: 18px 35px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 10000; animation: slide 0.6s; font-size: 1.2em; }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<!-- MODAL INTELIGENTE -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title" style="font-size:2.8em; margin-bottom:20px; color:#60a5fa;"></h2>
        <p id="modal-text" style="font-size:1.5em; margin-bottom:40px;"></p>
        <div id="modal-buttons"></div>
    </div>
</div>

<header>
    <div class="logo">
        <h1>NEXUS ITIL</h1>
        <p>Simulador Profesional v9.0 – Todo Funciona</p>
    </div>
    <div id="clock"></div>
</header>

<div class="dashboard">
    <aside class="sidebar">
        <button class="nav-btn active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button class="nav-btn" onclick="showSection('simulator')"><i class="fas fa-play-circle"></i> Simulador</button>
        <button class="nav-btn" onclick="showSection('incidents')"><i class="fas fa-exclamation-triangle"></i> Incidentes</button>
        <button class="nav-btn" onclick="showSection('problems')"><i class="fas fa-bug"></i> Problemas</button>
        <button class="nav-btn" onclick="showSection('kb')"><i class="fas fa-book"></i> Base de Conocimiento</button>
        <button class="nav-btn" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
        <button class="nav-btn" onclick="exportJSON()"><i class="fas fa-file-code"></i> Exportar JSON</button>
        <button class="nav-btn" onclick="clearAll()"><i class="fas fa-trash"></i> Limpiar Todo</button>
    </aside>

    <main class="main-content">

        <!-- DASHBOARD -->
        <div id="dashboard" class="section">
            <div class="widget">
                <h2><i class="fas fa-chart-line"></i> Centro de Operaciones</h2>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-value" id="k-inc">0</div><div>Incidentes</div></div>
                    <div class="kpi-card"><div class="kpi-value text-danger" id="k-crit">0</div><div>Críticos</div></div>
                    <div class="kpi-card"><div class="kpi-value text-success" id="k-res">0</div><div>Resueltos</div></div>
                    <div class="kpi-card"><div class="kpi-value">99.4%</div><div>SLA</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-box"><canvas id="chart-prio"></canvas></div>
                    <div class="chart-box"><canvas id="chart-trend"></canvas></div>
                </div>
            </div>
        </div>

        <!-- SIMULADOR -->
        <div id="simulator" class="section" style="display:none; text-align:center;">
            <div class="widget">
                <h2><i class="fas fa-robot"></i> Simulador Automático</h2>
                <div style="margin:60px 0;">
                    <button onclick="startGen('incident')" class="btn-giant btn-inc">Generar Incidentes Cada 5s</button>
                    <button onclick="startGen('problem')" class="btn-giant btn-prob">Generar Problemas Cada 5s</button>
                </div>
                <button onclick="stopGen()" class="btn-giant btn-stop">Detener Todo</button>

                <!-- BOTÓN QUE ABRE EL MODAL EXACTAMENTE COMO PEDISTE -->
                <div style="margin:80px 0;">
                    <button onclick="openResolveModal()" class="btn-giant btn-resolve" style="font-size:2em; padding:35px 70px;">
                        Simular la Resolución de Todos los Registros
                    </button>
                </div>

                <!-- Área de simulación (se muestra solo al elegir "Sí") -->
                <div id="simulation-area" class="simulation-box">
                    <h2><i class="fas fa-magic"></i> Simulación de Resolución en Curso</h2>
                    <div id="sim-steps"></div>
                    <canvas id="sim-chart" style="margin-top:40px;"></canvas>
                </div>
            </div>
        </div>

        <!-- INCIDENTES / PROBLEMAS / KB -->
        <div id="incidents" class="section" style="display:none;"><div class="widget"><h2>Incidentes</h2><div id="inc-table"></div></div></div>
        <div id="problems" class="section" style="display:none;"><div class="widget"><h2>Problemas</h2><div id="prob-table"></div></div></div>
        <div id="kb" class="section" style="display:none;"><div class="widget"><h2>Base de Conocimiento</h2><div id="kb-list" style="display:grid; gap:20px;"></div></div></div>
    </main>
</div>

<audio id="alert" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>

<script>
    let incidents = [], problems = [], resolvedCount = 0;
    let genInterval = null, simInterval = null;
    let charts = {};

    const incTemplates = ["Portal caído", "Correo falla", "VPN desconectada", "SAP lento", "Error 503", "AD falla"];
    const probTemplates = ["Caídas recurrentes", "Backup falla", "VPN inestable", "Alta carga"];

    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleString('es-ES'), 1000);

    function initCharts() {
        charts.prio = new Chart(document.getElementById('chart-prio'), { type: 'doughnut', data: { labels: ['Crítica','Alta','Media'], datasets: [{ data: [0,0,0], backgroundColor: ['#ef4444','#f59e0b','#3b82f6'] }] }, options: { responsive: true } });
        charts.trend = new Chart(document.getElementById('chart-trend'), { type: 'line', data: { labels: [], datasets: [{ label: 'Incidentes', data: [], borderColor: '#60a5fa' }] } });
        charts.sim = new Chart(document.getElementById('sim-chart'), { type: 'bar', data: { labels: ['Resueltos','Pendientes'], datasets: [{ data: [0,0], backgroundColor: ['#10b981','#ef4444'] }] } });
    }

    function updateCharts() {
        const c = incidents.filter(i => i.priority === 'Crítica').length;
        const a = incidents.filter(i => i.priority === 'Alta').length;
        const m = incidents.length - c - a;
        charts.prio.data.datasets[0].data = [c, a, m];
        charts.prio.update();

        document.getElementById('k-inc').textContent = incidents.length;
        document.getElementById('k-crit').textContent = c;
        document.getElementById('k-res').textContent = resolvedCount;
    }

    function showSection(s) {
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById(s).style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.onclick?.toString().includes(s) && b.classList.add('active'));
        if (s==='incidents') renderTable('inc');
        if (s==='problems') renderTable('prob');
    }

    function toast(msg) {
        const t = document.createElement('div'); t.className='toast'; t.innerHTML = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    function startGen(type) {
        clearInterval(genInterval);
        genInterval = setInterval(() => {
            const item = {
                id: type==='incident' ? 'INC'+String(1000+incidents.length+1).padStart(4,'0') : 'PRB'+String(problems.length+1).padStart(6,'0'),
                title: (type==='incident'?incTemplates:probTemplates)[Math.floor(Math.random()*(type==='incident'?incTemplates:probTemplates).length)],
                priority: type==='incident' ? ['Crítica','Alta','Media'][Math.floor(Math.random()*3)] : 'Alta',
                status: 'Nuevo', time: new Date().toLocaleTimeString()
            };
            if(type==='incident') incidents.unshift(item); else problems.unshift(item);
            if(item.priority==='Crítica') document.getElementById('alert').play();
            updateCharts();
            toast(`${type==='incident'?'Incidente':'Problema'} ${item.id} generado`);
        }, 5000);
    }

    function stopGen() { clearInterval(genInterval); toast("Generación detenida"); }

    // === MODAL EXACTAMENTE COMO PEDISTE ===
    function openResolveModal() {
        if (incidents.length + problems.length === 0) return alert("No hay registros para resolver");

        document.getElementById('modal-title').textContent = "Simulación de Resolución";
        document.getElementById('modal-text').textContent = "¿Deseas simular la resolución de todos los registros generados?";
        document.getElementById('modal-buttons').innerHTML = `
            <button class="btn-giant btn-resolve" style="margin:15px;" onclick="closeModal(); startSimulation()">Sí, resolver todo</button>
            <button class="btn-giant" style="background:#6b7280; margin:15px;" onclick="askWhatToSee()">No, solo quiero ver registros</button>
        `;
        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('show');
    }

    function askWhatToSee() {
        closeModal();
        document.getElementById('modal-title').textContent = "¿Qué deseas ver?";
        document.getElementById('modal-text').textContent = "";
        document.getElementById('modal-buttons').innerHTML = `
            <button class="btn-giant" style="background:#4361ee;" onclick="closeModal(); showSection('incidents')">Ver Incidentes</button>
            <button class="btn-giant" style="background:#ea580c;" onclick="closeModal(); showSection('problems')">Ver Problemas</button>
        `;
        document.getElementById('modal').classList.add('show');
    }

    function startSimulation() {
        document.getElementById('simulation-area').style.display = 'block';
        document.getElementById('sim-steps').innerHTML = '';
        let all = [...incidents, ...problems];
        let i = 0;
        resolvedCount = 0;

        simInterval = setInterval(() => {
            if (i >= all.length) {
                clearInterval(simInterval);
                addStep("SIMULACIÓN COMPLETA – " + resolvedCount + " registros resueltos", true);
                charts.sim.data.datasets[0].data = [resolvedCount, 0];
                charts.sim.update();
                return;
            }
            const item = all[i];
            addStep(`Resolviendo ${item.id}: ${item.title}...`);
            setTimeout(() => {
                item.status = "Resuelto";
                resolvedCount++;
                addStep(`${item.id} RESUELTO`, true);
                addToKB(item);
                updateCharts();
                renderTable('inc');
                renderTable('prob');
                charts.sim.data.datasets[0].data = [resolvedCount, all.length-resolvedCount];
                charts.sim.update();
            }, 2000);
            i++;
        }, 4500);
    }

    function addStep(text, success=false) {
        const s = document.createElement('div');
        s.className = 'step';
        s.innerHTML = `<i class="fas ${success?'fa-check-circle':'fa-cog fa-spin'}"></i> ${text}`;
        if(success) s.classList.add('success');
        document.getElementById('sim-steps').appendChild(s);
        setTimeout(() => s.classList.add('show'), 100);
    }

    function renderTable(type) {
        const data = type==='inc' ? incidents : problems;
        const container = document.getElementById(type==='inc'?'inc-table':'prob-table');
        container.innerHTML = `<table><thead><tr><th>ID</th><th>Título</th><th>Prioridad/Estado</th><th>Hora</th></tr></thead><tbody>
            ${data.map(x=>`<tr><td><strong>${x.id}</strong></td><td>${x.title}</td><td><span class="status ${type==='inc'?x.priority.toLowerCase():''} ${x.status.toLowerCase().replace(' ','-')}">${type==='inc'?x.priority+' - ':''}${x.status}</span></td><td>${x.time}</td></tr>`).join('')}
        </tbody></table>`;
    }

    function addToKB(item) {
        const div = document.createElement('div'); div.className='widget';
        div.innerHTML = `<strong>${item.id}</strong> – ${item.title}<br><em>Solución:</em> Reinicio + parche. Tiempo medio: 12 min`;
        document.getElementById('kb-list').prepend(div);
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.text('Reporte NEXUS ITIL v9.0', 20, 20);
        doc.setFontSize(12); doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 40);
        doc.text(`Incidentes: ${incidents.length} | Problemas: ${problems.length} | Resueltos: ${resolvedCount}`, 20, 50);
        doc.save('nexus-itil-v9.pdf');
        toast("PDF exportado");
    }

    function exportJSON() {
        const data = { incidents, problems, resolvedCount, fecha: new Date() };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='nexus-data.json'; a.click();
        toast("JSON exportado");
    }

    function clearAll() {
        if(confirm("¿Borrar todo?")) {
            incidents=[]; problems=[]; resolvedCount=0;
            clearInterval(genInterval); clearInterval(simInterval);
            document.getElementById('simulation-area').style.display='none';
            document.getElementById('kb-list').innerHTML='';
            updateCharts();
            renderTable('inc'); renderTable('prob');
            toast("Sistema limpio");
        }
    }

    // INICIO
    initCharts();
    showSection('simulator');
    renderTable('inc');
    renderTable('prob');
</script>
</body>
</html>
