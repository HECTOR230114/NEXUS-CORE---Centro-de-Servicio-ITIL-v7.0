<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ITIL v10.0 - Simulador Profesional Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root { --p: #4361ee; --s: #10b981; --w: #f59e0b; --d: #ef4444; --i: #3b82f6; --dark: #0f172a; }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a, #1e293b); color: #e2e8f0; min-height: 100vh; }
        header { background: rgba(15,23,42,0.98); backdrop-filter: blur(15px); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #334155; }
        .logo h1 { font-size: 3.2em; font-weight: 900; background: linear-gradient(90deg, #60a5fa, #a78bfa, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #clock { background: rgba(255,255,255,0.1); padding: 14px 30px; border-radius: 50px; font-weight: bold; }

        .dashboard { display: grid; grid-template-columns: 370px 1fr; height: calc(100vh - 100px); }
        .sidebar { background: rgba(15,23,42,0.98); padding: 30px; border-right: 1px solid #334155; overflow-y: auto; }
        .nav-btn { width: 100%; background: rgba(51,65,85,0.7); color: white; border: none; padding: 18px 22px; margin: 12px 0; border-radius: 16px; cursor: pointer; text-align: left; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 16px; transition: all 0.4s; }
        .nav-btn:hover, .nav-btn.active { background: linear-gradient(135deg, #4361ee, #3b82f6); transform: translateX(12px); box-shadow: 0 12px 35px rgba(67,97,238,0.6); }

        .main-content { padding: 40px; overflow-y: auto; }
        .widget { background: rgba(30,41,59,0.95); border-radius: 22px; padding: 35px; margin-bottom: 35px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 1px solid rgba(100,116,139,0.2); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin: 40px 0; }
        .kpi-card { background: linear-gradient(135deg, rgba(51,65,85,0.9), rgba(30,41,59,1)); padding: 30px; border-radius: 20px; text-align: center; border-left: 8px solid #4361ee; transition: 0.4s; }
        .kpi-card:hover { transform: translateY(-12px); }
        .kpi-value { font-size: 4.5em; font-weight: 900; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin-top: 40px; }
        .chart-box { background: rgba(15,23,42,0.9); padding: 30px; border-radius: 20px; }

        .btn-giant { padding: 25px 50px; font-size: 1.7em; border: none; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; margin: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); transition: all 0.5s; }
        .btn-inc { background: linear-gradient(135deg, #dc2626, #f87171); }
        .btn-prob { background: linear-gradient(135deg, #ea580c, #fb923c); }
        .btn-resolve { background: linear-gradient(135deg, #10b981, #34d399); }
        .btn-stop { background: #6b7280; }
        .btn-giant:hover { transform: translateY(-15px) scale(1.05); }

        table { width: 100%; border-collapse: collapse; margin: 25px 0; }
        th, td { padding: 18px; border-bottom: 1px solid #475569; text-align: left; }
        th { background: rgba(67,97,238,0.5); }
        .status { padding: 8px 16px; border-radius: 30px; font-weight: bold; font-size: 0.9em; }
        .critica { background: #ef4444; } .alta { background:#f59e0b; color:black; } .media { background:#3b82f6; } .baja { background:#64748b; }
        .nuevo { background:#ef4444; } .en-investigacion { background:#f59e0b; color:black; } .resuelto { background:#10b981; } .en-progreso { background:#3b82f6; }

        .simulation-box { background: rgba(15,23,42,0.95); border: 3px solid #10b981; border-radius: 20px; padding: 30px; margin-top: 40px; display: none; }
        .step { padding: 20px; background: rgba(51,65,85,0.7); border-radius: 14px; margin: 15px 0; border-left: 6px solid #64748b; opacity: 0; transform: translateX(-50px); transition: all 0.8s; }
        .step.show { opacity: 1; transform: translateX(0); }
        .step.success { border-left-color: #10b981; background: rgba(16,185,129,0.3); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; pointer-events: none; transition: 0.4s; }
        .modal.show { opacity: 1; pointer-events: all; }
        .modal-content { background: #1e293b; padding: 50px; border-radius: 24px; text-align: center; max-width: 600px; box-shadow: 0 30px 80px rgba(0,0,0,0.8); border: 2px solid #4361ee; }

        .toast { position: fixed; bottom: 30px; right: 30px; background: #10b981; color: white; padding: 18px 35px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 10000; animation: slide 0.6s; font-size: 1.2em; }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .detail-row { background: rgba(51,65,85,0.5); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .kb-card { background: linear-gradient(135deg, rgba(67,97,238,0.2), rgba(59,130,246,0.1)); padding: 25px; border-radius: 16px; margin: 20px 0; border-left: 5px solid #4361ee; }
        .kb-card h3 { color: #60a5fa; margin-bottom: 15px; }
        .kb-card .kb-meta { color: #94a3b8; font-size: 0.9em; margin: 10px 0; }
        .kb-solution { background: rgba(16,185,129,0.1); padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 3px solid #10b981; }
    </style>
</head>
<body>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title" style="font-size:2.8em; margin-bottom:20px; color:#60a5fa;"></h2>
        <p id="modal-text" style="font-size:1.5em; margin-bottom:40px;"></p>
        <div id="modal-buttons"></div>
    </div>
</div>

<header>
    <div class="logo">
        <h1>NEXUS ITIL</h1>
        <p>Simulador Profesional v10.0 ‚Äì Versi√≥n Completa Mejorada</p>
    </div>
    <div id="clock"></div>
</header>

<div class="dashboard">
    <aside class="sidebar">
        <button class="nav-btn active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button class="nav-btn" onclick="showSection('simulator')"><i class="fas fa-play-circle"></i> Simulador</button>
        <button class="nav-btn" onclick="showSection('incidents')"><i class="fas fa-exclamation-triangle"></i> Incidentes</button>
        <button class="nav-btn" onclick="showSection('problems')"><i class="fas fa-bug"></i> Problemas</button>
        <button class="nav-btn" onclick="showSection('kb')"><i class="fas fa-book"></i> Base de Conocimiento</button>
        <button class="nav-btn" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
        <button class="nav-btn" onclick="exportJSON()"><i class="fas fa-file-code"></i> Exportar JSON</button>
        <button class="nav-btn" onclick="clearAll()"><i class="fas fa-trash"></i> Limpiar Todo</button>
    </aside>

    <main class="main-content">

        <!-- DASHBOARD -->
        <div id="dashboard" class="section">
            <div class="widget">
                <h2><i class="fas fa-chart-line"></i> Centro de Operaciones</h2>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-value" id="k-inc">0</div><div>Incidentes</div></div>
                    <div class="kpi-card"><div class="kpi-value" style="color:#ef4444;" id="k-crit">0</div><div>Cr√≠ticos</div></div>
                    <div class="kpi-card"><div class="kpi-value" style="color:#10b981;" id="k-res">0</div><div>Resueltos</div></div>
                    <div class="kpi-card"><div class="kpi-value" id="k-prob">0</div><div>Problemas</div></div>
                    <div class="kpi-card"><div class="kpi-value" id="k-kb">0</div><div>Art√≠culos KB</div></div>
                    <div class="kpi-card"><div class="kpi-value">99.4%</div><div>SLA</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-box"><canvas id="chart-prio"></canvas></div>
                    <div class="chart-box"><canvas id="chart-trend"></canvas></div>
                    <div class="chart-box"><canvas id="chart-status"></canvas></div>
                    <div class="chart-box"><canvas id="chart-problems"></canvas></div>
                </div>
            </div>
        </div>

        <!-- SIMULADOR -->
        <div id="simulator" class="section" style="display:none; text-align:center;">
            <div class="widget">
                <h2><i class="fas fa-robot"></i> Simulador Autom√°tico</h2>
                <div style="margin:60px 0;">
                    <button onclick="startGen('incident')" class="btn-giant btn-inc">Generar Incidentes Cada 5s</button>
                    <button onclick="startGen('problem')" class="btn-giant btn-prob">Generar Problemas Cada 5s</button>
                </div>
                <button onclick="stopGen()" class="btn-giant btn-stop">Detener Todo</button>

                <div style="margin:80px 0;">
                    <button onclick="openResolveModal()" class="btn-giant btn-resolve" style="font-size:2em; padding:35px 70px;">
                        Simular la Resoluci√≥n de Todos los Registros
                    </button>
                </div>

                <div id="simulation-area" class="simulation-box">
                    <h2><i class="fas fa-magic"></i> Simulaci√≥n de Resoluci√≥n en Curso</h2>
                    <div id="sim-steps"></div>
                    <canvas id="sim-chart" style="margin-top:40px;"></canvas>
                </div>
            </div>
        </div>

        <!-- INCIDENTES -->
        <div id="incidents" class="section" style="display:none;">
            <div class="widget">
                <h2><i class="fas fa-exclamation-triangle"></i> Gesti√≥n de Incidentes</h2>
                <div id="inc-table"></div>
            </div>
        </div>

        <!-- PROBLEMAS -->
        <div id="problems" class="section" style="display:none;">
            <div class="widget">
                <h2><i class="fas fa-bug"></i> Gesti√≥n de Problemas</h2>
                <div id="prob-table"></div>
            </div>
        </div>

        <!-- BASE DE CONOCIMIENTO -->
        <div id="kb" class="section" style="display:none;">
            <div class="widget">
                <h2><i class="fas fa-book"></i> Base de Conocimiento</h2>
                <p style="margin-bottom:20px; color:#94a3b8;">Art√≠culos generados autom√°ticamente a partir de incidentes y problemas resueltos</p>
                <div id="kb-list"></div>
            </div>
        </div>
    </main>
</div>

<audio id="alert" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>

<script>
    let incidents = [], problems = [], resolvedCount = 0, kbArticles = [];
    let genInterval = null, simInterval = null;
    let charts = {};

    const incTemplates = [
        {title: "Portal web ca√≠do", desc: "El portal principal no responde", category: "Infraestructura", affected: "500+ usuarios", impact: "Alto"},
        {title: "Servicio de correo falla", desc: "Imposible enviar/recibir emails", category: "Comunicaciones", affected: "300 usuarios", impact: "Cr√≠tico"},
        {title: "VPN desconectada", desc: "Conexi√≥n VPN intermitente", category: "Red", affected: "150 usuarios", impact: "Medio"},
        {title: "SAP responde lento", desc: "Tiempos de respuesta >10s", category: "Aplicaciones", affected: "200 usuarios", impact: "Alto"},
        {title: "Error 503 en API", desc: "Servicio no disponible", category: "Desarrollo", affected: "80 usuarios", impact: "Cr√≠tico"},
        {title: "Active Directory falla", desc: "Imposible autenticar usuarios", category: "Seguridad", affected: "1000+ usuarios", impact: "Cr√≠tico"},
        {title: "Base de datos Oracle ca√≠da", desc: "DB no responde a consultas", category: "Datos", affected: "400 usuarios", impact: "Cr√≠tico"},
        {title: "Impresoras red offline", desc: "Impresoras no detectadas", category: "Hardware", affected: "50 usuarios", impact: "Bajo"},
    ];

    const probTemplates = [
        {title: "Ca√≠das recurrentes del portal", desc: "Portal cae cada 3 horas", rootCause: "Fuga de memoria en servidor Apache", category: "Infraestructura"},
        {title: "Backup nocturno falla", desc: "Backups fallan sistem√°ticamente", rootCause: "Espacio insuficiente en disco", category: "Almacenamiento"},
        {title: "VPN inestable despu√©s de actualizaci√≥n", desc: "Conexiones caen tras 15 min", rootCause: "Incompatibilidad con firewall v8.2", category: "Red"},
        {title: "Alta carga en DB producci√≥n", desc: "CPU al 95% constante", rootCause: "Consultas sin √≠ndices optimizados", category: "Base de Datos"},
        {title: "Correos marcados como spam", desc: "Emails corporativos van a spam", rootCause: "Configuraci√≥n SPF/DKIM incorrecta", category: "Comunicaciones"},
        {title: "Lentitud general en aplicaciones", desc: "Todas las apps responden lento", rootCause: "Switch principal saturado", category: "Red"},
    ];

    const solutions = [
        "Reinicio del servicio + aplicaci√≥n de parche de seguridad actualizado",
        "Limpieza de cach√© + optimizaci√≥n de consultas SQL + reinicio programado",
        "Actualizaci√≥n de firmware + configuraci√≥n de par√°metros de red",
        "Restauraci√≥n desde backup + verificaci√≥n de integridad de datos",
        "Reemplazo de componente hardware defectuoso + pruebas de estr√©s",
        "Ajuste de configuraci√≥n + documentaci√≥n actualizada + monitoreo 24/7",
        "Implementaci√≥n de workaround temporal + escalamiento a fabricante",
        "Reinicio de servicios dependientes + limpieza de logs + verificaci√≥n de permisos"
    ];

    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleString('es-ES'), 1000);

    function initCharts() {
        charts.prio = new Chart(document.getElementById('chart-prio'), { 
            type: 'doughnut', 
            data: { 
                labels: ['Cr√≠tica','Alta','Media','Baja'], 
                datasets: [{ 
                    data: [0,0,0,0], 
                    backgroundColor: ['#ef4444','#f59e0b','#3b82f6','#64748b'] 
                }] 
            }, 
            options: { 
                responsive: true,
                plugins: { 
                    title: { display: true, text: 'Incidentes por Prioridad', color: '#e2e8f0' },
                    legend: { labels: { color: '#e2e8f0' } }
                } 
            } 
        });

        charts.trend = new Chart(document.getElementById('chart-trend'), { 
            type: 'line', 
            data: { 
                labels: [], 
                datasets: [
                    { label: 'Incidentes', data: [], borderColor: '#60a5fa', tension: 0.4 },
                    { label: 'Problemas', data: [], borderColor: '#f59e0b', tension: 0.4 }
                ] 
            },
            options: {
                responsive: true,
                plugins: { 
                    title: { display: true, text: 'Tendencia Temporal', color: '#e2e8f0' },
                    legend: { labels: { color: '#e2e8f0' } }
                },
                scales: {
                    y: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } }
                }
            }
        });

        charts.status = new Chart(document.getElementById('chart-status'), {
            type: 'bar',
            data: {
                labels: ['Nuevo', 'En Progreso', 'En Investigaci√≥n', 'Resuelto'],
                datasets: [{
                    label: 'Estados',
                    data: [0,0,0,0],
                    backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981']
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    title: { display: true, text: 'Incidentes por Estado', color: '#e2e8f0' },
                    legend: { labels: { color: '#e2e8f0' } }
                },
                scales: {
                    y: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } }
                }
            }
        });

        charts.problems = new Chart(document.getElementById('chart-problems'), {
            type: 'pie',
            data: {
                labels: ['Infraestructura', 'Red', 'Aplicaciones', 'Base de Datos', 'Otros'],
                datasets: [{
                    data: [0,0,0,0,0],
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#64748b']
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    title: { display: true, text: 'Problemas por Categor√≠a', color: '#e2e8f0' },
                    legend: { labels: { color: '#e2e8f0' } }
                }
            }
        });

        charts.sim = new Chart(document.getElementById('sim-chart'), { 
            type: 'bar', 
            data: { 
                labels: ['Resueltos','Pendientes'], 
                datasets: [{ 
                    data: [0,0], 
                    backgroundColor: ['#10b981','#ef4444'] 
                }] 
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#e2e8f0' } } },
                scales: {
                    y: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } }
                }
            }
        });
    }

    function updateCharts() {
        // Incidentes por prioridad
        const crit = incidents.filter(i => i.priority === 'Cr√≠tica').length;
        const alta = incidents.filter(i => i.priority === 'Alta').length;
        const media = incidents.filter(i => i.priority === 'Media').length;
        const baja = incidents.filter(i => i.priority === 'Baja').length;
        charts.prio.data.datasets[0].data = [crit, alta, media, baja];
        charts.prio.update();

        // Incidentes por estado
        const nuevo = incidents.filter(i => i.status === 'Nuevo').length;
        const progreso = incidents.filter(i => i.status === 'En Progreso').length;
        const investig = incidents.filter(i => i.status === 'En Investigaci√≥n').length;
        const resuelto = incidents.filter(i => i.status === 'Resuelto').length;
        charts.status.data.datasets[0].data = [nuevo, progreso, investig, resuelto];
        charts.status.update();

        // Problemas por categor√≠a
        const catCount = {};
        problems.forEach(p => {
            catCount[p.category] = (catCount[p.category] || 0) + 1;
        });
        const cats = ['Infraestructura', 'Red', 'Aplicaciones', 'Base de Datos', 'Otros'];
        charts.problems.data.datasets[0].data = cats.map(c => catCount[c] || 0);
        charts.problems.update();

        // KPIs
        document.getElementById('k-inc').textContent = incidents.length;
        document.getElementById('k-crit').textContent = crit;
        document.getElementById('k-res').textContent = resolvedCount;
        document.getElementById('k-prob').textContent = problems.length;
        document.getElementById('k-kb').textContent = kbArticles.length;
    }

    function showSection(s) {
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById(s).style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        // Activar el bot√≥n correspondiente
        document.querySelectorAll('.nav-btn').forEach(b => {
            if (b.getAttribute('onclick')?.includes(s)) {
                b.classList.add('active');
            }
        });
        
        if (s==='incidents') renderTable('inc');
        if (s==='problems') renderTable('prob');
        if (s==='kb') renderKB();
    }

    function toast(msg) {
        const t = document.createElement('div'); 
        t.className='toast'; 
        t.innerHTML = msg; 
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    function startGen(type) {
        clearInterval(genInterval);
        const templates = type === 'incident' ? incTemplates : probTemplates;
        
        genInterval = setInterval(() => {
            const template = templates[Math.floor(Math.random() * templates.length)];
            const priorities = ['Cr√≠tica', 'Alta', 'Media', 'Baja'];
            const statuses = ['Nuevo', 'En Progreso', 'En Investigaci√≥n'];
            
            if (type === 'incident') {
                const item = {
                    id: 'INC' + String(10000 + incidents.length + 1).padStart(6, '0'),
                    title: template.title,
                    description: template.desc,
                    category: template.category,
                    affected: template.affected,
                    impact: template.impact,
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    time: new Date().toLocaleString('es-ES'),
                    assignedTo: ['Juan P√©rez', 'Mar√≠a Garc√≠a', 'Carlos L√≥pez', 'Ana Mart√≠nez'][Math.floor(Math.random() * 4)],
                    sla: Math.floor(Math.random() * 240) + ' min'
                };
                incidents.unshift(item);
                if (item.priority === 'Cr√≠tica') document.getElementById('alert').play();
            } else {
                const item = {
                    id: 'PRB' + String(100000 + problems.length + 1).padStart(7, '0'),
                    title: template.title,
                    description: template.desc,
                    rootCause: template.rootCause,
                    category: template.category,
                    priority: 'Alta',
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    time: new Date().toLocaleString('es-ES'),
                    relatedIncidents: Math.floor(Math.random() * 15) + 3,
                    assignedTo: ['Equipo Infraestructura', 'Equipo Red', 'Equipo Desarrollo'][Math.floor(Math.random() * 3)]
                };
                problems.unshift(item);
            }
            
            updateCharts();
            toast(`${type === 'incident' ? 'Incidente' : 'Problema'} generado correctamente`);
        }, 5000);
    }

    function stopGen() { 
        clearInterval(genInterval); 
        toast("Generaci√≥n autom√°tica detenida"); 
    }

    function openResolveModal() {
        if (incidents.length + problems.length === 0) {
            toast("‚ö†Ô∏è No hay registros para resolver");
            return;
        }

        document.getElementById('modal-title').textContent = "Simulaci√≥n de Resoluci√≥n";
        document.getElementById('modal-text').textContent = `¬øDeseas simular la resoluci√≥n de todos los registros generados? (${incidents.length} incidentes + ${problems.length} problemas)`;
        document.getElementById('modal-buttons').innerHTML = `
            <button class="btn-giant btn-resolve" style="margin:15px;" onclick="closeModal(); startSimulation()">S√≠, resolver todo</button>
            <button class="btn-giant" style="background:#6b7280; margin:15px;" onclick="askWhatToSee()">No, solo ver registros</button>
        `;
        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('show');
    }

    function askWhatToSee() {
        closeModal();
        document.getElementById('modal-title').textContent = "¬øQu√© deseas ver?";
        document.getElementById('modal-text').textContent = "";
        document.getElementById('modal-buttons').innerHTML = `
            <button class="btn-giant" style="background:#4361ee;" onclick="closeModal(); showSection('incidents')">Ver Incidentes</button>
            <button class="btn-giant" style="background:#ea580c;" onclick="closeModal(); showSection('problems')">Ver Problemas</button>
            <button class="btn-giant" style="background:#10b981;" onclick="closeModal(); showSection('kb')">Ver Base de Conocimiento</button>
        `;
        document.getElementById('modal').classList.add('show');
    }

    function startSimulation() {
        showSection('simulator');
        document.getElementById('simulation-area').style.display = 'block';
        document.getElementById('sim-steps').innerHTML = '';
        let all = [...incidents, ...problems];
        let i = 0;
        resolvedCount = 0;

        simInterval = setInterval(() => {
            if (i >= all.length) {
                clearInterval(simInterval);
                addStep("‚úÖ SIMULACI√ìN COMPLETA ‚Äì " + resolvedCount + " registros resueltos exitosamente", true);
                charts.sim.data.datasets[0].data = [resolvedCount, 0];
                charts.sim.update();
                toast("üéâ Simulaci√≥n completada con √©xito");
                return;
            }
            const item = all[i];
            addStep(`‚öôÔ∏è Procesando ${item.id}: ${item.title}...`);
            setTimeout(() => {
                item.status = "Resuelto";
                resolvedCount++;
                addStep(`‚úì ${item.id} RESUELTO CORRECTAMENTE`, true);
                addToKB(item);
                updateCharts();
                renderTable('inc');
                renderTable('prob');
                charts.sim.data.datasets[0].data = [resolvedCount, all.length - resolvedCount];
                charts.sim.update();
            }, 2000);
            i++;
        }, 4500);
    }

    function addStep(text, success = false) {
        const s = document.createElement('div');
        s.className = 'step';
        s.innerHTML = `<i class="fas ${success ? 'fa-check-circle' : 'fa-cog fa-spin'}"></i> ${text}`;
        if (success) s.classList.add('success');
        document.getElementById('sim-steps').appendChild(s);
        setTimeout(() => s.classList.add('show'), 100);
    }

    function renderTable(type) {
        const data = type === 'inc' ? incidents : problems;
        const container = document.getElementById(type === 'inc' ? 'inc-table' : 'prob-table');
        
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:40px;">No hay registros disponibles</p>';
            return;
        }

        if (type === 'inc') {
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Categor√≠a</th>
                            <th>Afectados</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Responsable</th>
                            <th>SLA</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(x => `
                            <tr>
                                <td><strong>${x.id}</strong></td>
                                <td>
                                    <strong>${x.title}</strong><br>
                                    <small style="color:#94a3b8;">${x.description}</small>
                                </td>
                                <td>${x.category}</td>
                                <td>${x.affected}</td>
                                <td><span class="status ${x.priority.toLowerCase()}">${x.priority}</span></td>
                                <td><span class="status ${x.status.toLowerCase().replace(/ /g, '-')}">${x.status}</span></td>
                                <td>${x.assignedTo}</td>
                                <td>${x.sla}</td>
                                <td>${x.time}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Categor√≠a</th>
                            <th>Causa Ra√≠z</th>
                            <th>Inc. Relacionados</th>
                            <th>Estado</th>
                            <th>Equipo</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(x => `
                            <tr>
                                <td><strong>${x.id}</strong></td>
                                <td>
                                    <strong>${x.title}</strong><br>
                                    <small style="color:#94a3b8;">${x.description}</small>
                                </td>
                                <td>${x.category}</td>
                                <td><em style="color:#f59e0b;">${x.rootCause}</em></td>
                                <td><span class="status media">${x.relatedIncidents}</span></td>
                                <td><span class="status ${x.status.toLowerCase().replace(/ /g, '-')}">${x.status}</span></td>
                                <td>${x.assignedTo}</td>
                                <td>${x.time}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    }

    function addToKB(item) {
        const solution = solutions[Math.floor(Math.random() * solutions.length)];
        const timeResolved = Math.floor(Math.random() * 45) + 5;
        
        const article = {
            id: 'KB' + String(10000 + kbArticles.length + 1).padStart(6, '0'),
            sourceId: item.id,
            title: item.title,
            category: item.category,
            description: item.description || item.rootCause || 'Problema identificado y resuelto',
            solution: solution,
            timeResolved: timeResolved + ' min',
            author: item.assignedTo || 'Sistema Autom√°tico',
            date: new Date().toLocaleString('es-ES'),
            views: 0,
            helpful: 0
        };
        
        kbArticles.unshift(article);
        updateCharts();
    }

    function renderKB() {
        const container = document.getElementById('kb-list');
        
        if (kbArticles.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:40px;">No hay art√≠culos en la base de conocimiento. Resuelve algunos incidentes o problemas para generar contenido.</p>';
            return;
        }

        container.innerHTML = kbArticles.map(article => `
            <div class="kb-card">
                <h3><i class="fas fa-lightbulb"></i> ${article.title}</h3>
                <div class="kb-meta">
                    <i class="fas fa-tag"></i> <strong>ID:</strong> ${article.id} | 
                    <i class="fas fa-link"></i> <strong>Origen:</strong> ${article.sourceId} | 
                    <i class="fas fa-folder"></i> <strong>Categor√≠a:</strong> ${article.category}
                </div>
                <div class="kb-meta">
                    <i class="fas fa-user"></i> <strong>Autor:</strong> ${article.author} | 
                    <i class="fas fa-clock"></i> <strong>Fecha:</strong> ${article.date} | 
                    <i class="fas fa-hourglass-half"></i> <strong>Tiempo resoluci√≥n:</strong> ${article.timeResolved}
                </div>
                <div class="detail-row">
                    <strong><i class="fas fa-info-circle"></i> Descripci√≥n:</strong><br>
                    ${article.description}
                </div>
                <div class="kb-solution">
                    <strong><i class="fas fa-check-circle"></i> Soluci√≥n Aplicada:</strong><br>
                    ${article.solution}
                </div>
                <div style="margin-top:15px; color:#64748b;">
                    <i class="fas fa-eye"></i> ${article.views} vistas | 
                    <i class="fas fa-thumbs-up"></i> ${article.helpful} √∫til
                </div>
            </div>
        `).join('');
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // PORTADA
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(96, 165, 250);
        doc.setFontSize(32);
        doc.text('NEXUS ITIL v10.0', 105, 80, { align: 'center' });
        doc.setFontSize(18);
        doc.setTextColor(226, 232, 240);
        doc.text('Reporte Completo de Gesti√≥n', 105, 100, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 105, 120, { align: 'center' });
        
        // RESUMEN EJECUTIVO
        doc.addPage();
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(20);
        doc.text('Resumen Ejecutivo', 20, 20);
        doc.setFontSize(12);
        doc.text(`Total Incidentes: ${incidents.length}`, 20, 35);
        doc.text(`Total Problemas: ${problems.length}`, 20, 45);
        doc.text(`Registros Resueltos: ${resolvedCount}`, 20, 55);
        doc.text(`Art√≠culos KB: ${kbArticles.length}`, 20, 65);
        doc.text(`SLA Compliance: 99.4%`, 20, 75);
        
        // ESTAD√çSTICAS
        const criticos = incidents.filter(i => i.priority === 'Cr√≠tica').length;
        const altos = incidents.filter(i => i.priority === 'Alta').length;
        const medios = incidents.filter(i => i.priority === 'Media').length;
        doc.text('Distribuci√≥n por Prioridad:', 20, 90);
        doc.text(`  ‚Ä¢ Cr√≠tica: ${criticos}`, 25, 100);
        doc.text(`  ‚Ä¢ Alta: ${altos}`, 25, 110);
        doc.text(`  ‚Ä¢ Media: ${medios}`, 25, 120);
        
        // TABLA DE INCIDENTES
        if (incidents.length > 0) {
            doc.addPage();
            doc.setFontSize(18);
            doc.text('Detalle de Incidentes', 20, 20);
            
            const incData = incidents.map(inc => [
                inc.id,
                inc.title.substring(0, 30),
                inc.category,
                inc.priority,
                inc.status,
                inc.assignedTo,
                inc.time
            ]);
            
            doc.autoTable({
                startY: 30,
                head: [['ID', 'T√≠tulo', 'Categor√≠a', 'Prioridad', 'Estado', 'Responsable', 'Hora']],
                body: incData,
                theme: 'grid',
                headStyles: { fillColor: [67, 97, 238] },
                styles: { fontSize: 8 }
            });
        }
        
        // TABLA DE PROBLEMAS
        if (problems.length > 0) {
            doc.addPage();
            doc.setFontSize(18);
            doc.text('Detalle de Problemas', 20, 20);
            
            const probData = problems.map(prob => [
                prob.id,
                prob.title.substring(0, 25),
                prob.category,
                prob.rootCause.substring(0, 35),
                String(prob.relatedIncidents),
                prob.status,
                prob.assignedTo
            ]);
            
            doc.autoTable({
                startY: 30,
                head: [['ID', 'T√≠tulo', 'Categor√≠a', 'Causa Ra√≠z', 'Inc. Rel.', 'Estado', 'Equipo']],
                body: probData,
                theme: 'grid',
                headStyles: { fillColor: [234, 88, 12] },
                styles: { fontSize: 8 }
            });
        }
        
        // BASE DE CONOCIMIENTO
        if (kbArticles.length > 0) {
            doc.addPage();
            doc.setFontSize(18);
            doc.text('Base de Conocimiento', 20, 20);
            
            const kbData = kbArticles.map(kb => [
                kb.id,
                kb.title.substring(0, 30),
                kb.category,
                kb.solution.substring(0, 40),
                kb.timeResolved
            ]);
            
            doc.autoTable({
                startY: 30,
                head: [['ID', 'T√≠tulo', 'Categor√≠a', 'Soluci√≥n', 'Tiempo']],
                body: kbData,
                theme: 'grid',
                headStyles: { fillColor: [16, 185, 129] },
                styles: { fontSize: 8 }
            });
        }
        
        doc.save('nexus-itil-v10-reporte-completo.pdf');
        toast("üìÑ PDF exportado exitosamente");
    }

    function exportJSON() {
        const data = {
            metadata: {
                version: '10.0',
                generated: new Date().toISOString(),
                summary: {
                    totalIncidents: incidents.length,
                    totalProblems: problems.length,
                    resolvedCount: resolvedCount,
                    kbArticles: kbArticles.length
                }
            },
            incidents: incidents,
            problems: problems,
            knowledgeBase: kbArticles
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nexus-itil-v10-data.json';
        a.click();
        toast("üíæ JSON exportado exitosamente");
    }

    function clearAll() {
        if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas borrar todos los datos? Esta acci√≥n no se puede deshacer.")) {
            incidents = [];
            problems = [];
            kbArticles = [];
            resolvedCount = 0;
            clearInterval(genInterval);
            clearInterval(simInterval);
            document.getElementById('simulation-area').style.display = 'none';
            updateCharts();
            renderTable('inc');
            renderTable('prob');
            renderKB();
            toast("üóëÔ∏è Sistema limpio - Todos los datos eliminados");
        }
    }

    // INICIALIZACI√ìN
    window.addEventListener('DOMContentLoaded', () => {
        initCharts();
        showSection('simulator');
        renderTable('inc');
        renderTable('prob');
        renderKB();
        toast("‚ú® Sistema NEXUS ITIL v10.0 iniciado correctamente");
    });
</script>
</body>
</html>
